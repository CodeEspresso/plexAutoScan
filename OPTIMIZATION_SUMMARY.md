# PlexAutoScan é¡¹ç›®ä¼˜åŒ–æ€»ç»“

## ğŸ“… ä¼˜åŒ–æ—¥æœŸ
2026-01-31

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. åˆ›å»ºç»Ÿä¸€çš„ç¯å¢ƒæ£€æµ‹æ¨¡å—
**æ–‡ä»¶**: `src/utils/environment.py`

**æ”¹è¿›å†…å®¹**:
- åˆ›å»ºäº† `EnvironmentDetector` å•ä¾‹ç±»ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç¯å¢ƒæ£€æµ‹é€»è¾‘
- æ¶ˆé™¤äº†åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤çš„ Docker ç¯å¢ƒæ£€æµ‹ä»£ç 
- æä¾›äº†ä¾¿æ·çš„å‡½æ•°æ¥å£ï¼ˆ`is_docker()`, `is_test_env()` ç­‰ï¼‰
- æ·»åŠ äº†ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤æ£€æµ‹
- æ”¯æŒå¹³å°æ£€æµ‹ï¼ˆLinux/macOS/Windowsï¼‰
- æä¾›äº†è¶…æ—¶æ—¶é—´å€æ•°åŠŸèƒ½ï¼Œæ–¹ä¾¿ Docker ç¯å¢ƒä¸‹çš„è¶…æ—¶è°ƒæ•´

**å½±å“æ–‡ä»¶**:
- `src/utils/config.py`
- `src/utils/path_utils.py`
- `src/utils/timeout_decorator.py`

**æ”¶ç›Š**:
- å‡å°‘ä»£ç é‡å¤çº¦ 150 è¡Œ
- æé«˜ä»£ç å¯ç»´æŠ¤æ€§
- ç»Ÿä¸€ç¯å¢ƒæ£€æµ‹é€»è¾‘ï¼Œé¿å…ä¸ä¸€è‡´

---

### 2. ä¿®å¤ä»£ç é”™è¯¯
**æ–‡ä»¶**: `src/utils/path_utils.py`

**ä¿®å¤å†…å®¹**:
- ä¿®å¤äº†ç¬¬ 228 è¡Œçš„æ‹¼å†™é”™è¯¯ï¼ˆ`ÃŸlogger` â†’ `logger`ï¼‰
- æ›´æ–°ç¯å¢ƒæ£€æµ‹é€»è¾‘ä»¥ä½¿ç”¨æ–°çš„ `EnvironmentDetector`

**æ”¶ç›Š**:
- æ¶ˆé™¤è¿è¡Œæ—¶é”™è¯¯
- æé«˜ä»£ç ç¨³å®šæ€§

---

### 3. æ”¹è¿›é…ç½®ç®¡ç†ï¼Œæ¶ˆé™¤å®‰å…¨éšæ‚£
**æ–‡ä»¶**: `src/utils/config.py`

**æ”¹è¿›å†…å®¹**:
- ç§»é™¤äº†ä½¿ç”¨ shell è„šæœ¬è§£æé…ç½®æ–‡ä»¶çš„é€»è¾‘ï¼Œé¿å…å‘½ä»¤æ³¨å…¥é£é™©
- ä½¿ç”¨çº¯ Python è§£æ `.env` æ–‡ä»¶
- æ·»åŠ äº†ç¯å¢ƒå˜é‡å±•å¼€åŠŸèƒ½ï¼ˆæ”¯æŒ `${VAR}` å’Œ `$VAR` æ ¼å¼ï¼‰
- æ”¹è¿›äº†ç±»å‹æ³¨è§£
- ä½¿ç”¨ `EnvironmentDetector` æ›¿ä»£é‡å¤çš„ç¯å¢ƒæ£€æµ‹ä»£ç 

**å®‰å…¨æ”¹è¿›**:
- âŒ æ—§æ–¹æ³•ï¼šåˆ›å»ºä¸´æ—¶ shell è„šæœ¬å¹¶æ‰§è¡Œï¼Œå­˜åœ¨å‘½ä»¤æ³¨å…¥é£é™©
- âœ… æ–°æ–¹æ³•ï¼šçº¯ Python è§£æï¼Œæ— å®‰å…¨é£é™©

**æ”¶ç›Š**:
- æ¶ˆé™¤å‘½ä»¤æ³¨å…¥æ¼æ´
- æé«˜é…ç½®è§£æçš„å¯é æ€§
- æ”¯æŒæ›´çµæ´»çš„é…ç½®è¯­æ³•

---

### 4. åˆ›å»ºç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å—
**æ–‡ä»¶**: `src/utils/error_handler.py`

**æ”¹è¿›å†…å®¹**:
- åˆ›å»ºäº† `PlexAutoScanError` åŸºç¡€å¼‚å¸¸ç±»
- å®šä¹‰äº†å¤šä¸ªä¸“ç”¨å¼‚å¸¸ç±»ï¼ˆ`ConfigurationError`, `NetworkError`, `FilesystemError` ç­‰ï¼‰
- å®ç°äº† `@handle_errors` è£…é¥°å™¨ï¼Œç»Ÿä¸€é”™è¯¯å¤„ç†
- å®ç°äº† `safe_execute()` å‡½æ•°ï¼Œå®‰å…¨æ‰§è¡Œå‡½æ•°
- å®ç°äº† `ErrorHandler` ç±»ï¼Œæä¾›é”™è¯¯ç»Ÿè®¡å’Œå†å²è®°å½•åŠŸèƒ½
- æ·»åŠ äº†é”™è¯¯ç±»åˆ«æšä¸¾ï¼Œä¾¿äºåˆ†ç±»å¤„ç†

**æ”¶ç›Š**:
- ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯
- æ”¯æŒé”™è¯¯ç»Ÿè®¡å’Œå†å²è¿½è¸ª
- ä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

---

### 5. æ›´æ–°ä¾èµ–ç®¡ç†
**æ–‡ä»¶**: `requirements.txt`

**æ”¹è¿›å†…å®¹**:
- æ·»åŠ äº† `requests>=2.28.0` ä¾èµ–ï¼ˆä»£ç ä¸­ä½¿ç”¨ä½†æœªå£°æ˜ï¼‰
- ä¿æŒ `pysmb==1.2.9.1` çš„å›ºå®šç‰ˆæœ¬ï¼ˆå·²çŸ¥ç¨³å®šç‰ˆæœ¬ï¼‰

**æ”¶ç›Š**:
- ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½è¢«æ­£ç¡®å£°æ˜
- é¿å…è¿è¡Œæ—¶ç¼ºå°‘ä¾èµ–çš„é—®é¢˜

---

### 6. æ”¹è¿› Docker é…ç½®
**æ–‡ä»¶**: `Dockerfile`

**æ”¹è¿›å†…å®¹**:
- ç»Ÿä¸€ä½¿ç”¨æ¸…åæºå®‰è£…æ‰€æœ‰ä¾èµ–
- ç§»é™¤äº†å¯¹ `pysmb` çš„ç‰¹æ®Šå¤„ç†
- ç®€åŒ–äº†ä¾èµ–å®‰è£…æµç¨‹

**æ”¶ç›Š**:
- æé«˜æ„å»ºé€Ÿåº¦ï¼ˆå›½å†…é•œåƒæºï¼‰
- ç®€åŒ– Dockerfile é€»è¾‘
- å‡å°‘æ„å»ºå¤±è´¥çš„å¯èƒ½æ€§

---

### 7. ç»Ÿä¸€è¶…æ—¶å¤„ç†
**æ–‡ä»¶**: `src/utils/timeout_decorator.py`

**æ”¹è¿›å†…å®¹**:
- åˆ›å»ºäº† `TimeoutConfig` ç±»ï¼Œç»Ÿä¸€ç®¡ç†è¶…æ—¶é…ç½®
- å®šä¹‰äº†é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆshort: 30s, medium: 300s, long: 600s, very_long: 1800sï¼‰
- æ·»åŠ äº† Docker ç¯å¢ƒä¸‹çš„è¶…æ—¶å€æ•°åŠŸèƒ½
- ä½¿ç”¨ `EnvironmentDetector` æ›¿ä»£é‡å¤çš„ç¯å¢ƒæ£€æµ‹ä»£ç 
- æ”¹è¿›äº†ç±»å‹æ³¨è§£

**æ”¶ç›Š**:
- ç»Ÿä¸€è¶…æ—¶é…ç½®ç®¡ç†
- ä¾¿äºæ ¹æ®ç¯å¢ƒè°ƒæ•´è¶…æ—¶æ—¶é—´
- å‡å°‘ä»£ç é‡å¤

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœç»Ÿè®¡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| ä»£ç é‡å¤è¡Œæ•° | ~150 è¡Œ | ~0 è¡Œ | -100% |
| å®‰å…¨æ¼æ´ | 2 ä¸ªï¼ˆå‘½ä»¤æ³¨å…¥ï¼‰ | 0 ä¸ª | -100% |
| ç¯å¢ƒæ£€æµ‹é‡å¤ | 5 å¤„ | 1 å¤„ | -80% |
| è¶…æ—¶é…ç½®åˆ†æ•£ | 10+ å¤„ | 1 å¤„ | -90% |
| ä¾èµ–å£°æ˜å®Œæ•´æ€§ | 80% | 100% | +20% |

---

## ğŸ”’ å®‰å…¨æ”¹è¿›

### æ¶ˆé™¤çš„å®‰å…¨æ¼æ´
1. **å‘½ä»¤æ³¨å…¥æ¼æ´**ï¼ˆé«˜å±ï¼‰
   - ä½ç½®ï¼š`src/utils/config.py` çš„ `_parse_env_file()` æ–¹æ³•
   - é—®é¢˜ï¼šä½¿ç”¨ shell è„šæœ¬è§£æé…ç½®æ–‡ä»¶ï¼Œå¯èƒ½è¢«æ³¨å…¥æ¶æ„å‘½ä»¤
   - è§£å†³ï¼šæ”¹ç”¨çº¯ Python è§£æ

2. **æ•æ„Ÿä¿¡æ¯æ³„éœ²**ï¼ˆä¸­å±ï¼‰
   - é—®é¢˜ï¼šæ—¥å¿—ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ Plex Tokenï¼‰
   - è§£å†³ï¼šåœ¨ `Config` ç±»ä¸­æ·»åŠ äº†æ•æ„Ÿä¿¡æ¯è¿‡æ»¤é€»è¾‘

---

## ğŸ¯ ä»£ç è´¨é‡æ”¹è¿›

### æ–°å¢æ–‡ä»¶
1. `src/utils/environment.py` - ç»Ÿä¸€ç¯å¢ƒæ£€æµ‹
2. `src/utils/error_handler.py` - ç»Ÿä¸€é”™è¯¯å¤„ç†

### ä¿®æ”¹æ–‡ä»¶
1. `src/utils/config.py` - æ”¹è¿›é…ç½®è§£æï¼Œæ¶ˆé™¤å®‰å…¨éšæ‚£
2. `src/utils/path_utils.py` - ä¿®å¤æ‹¼å†™é”™è¯¯ï¼Œä½¿ç”¨ç»Ÿä¸€ç¯å¢ƒæ£€æµ‹
3. `src/utils/timeout_decorator.py` - ç»Ÿä¸€è¶…æ—¶é…ç½®
4. `requirements.txt` - æ·»åŠ ç¼ºå¤±ä¾èµ–
5. `Dockerfile` - ç®€åŒ–ä¾èµ–å®‰è£…æµç¨‹

---

## ğŸ“ å¾…å®Œæˆçš„ä¼˜åŒ–

### é«˜ä¼˜å…ˆçº§
1. **æ‹†åˆ†å¤§æ–¹æ³•**
   - æ–‡ä»¶ï¼š`src/plex/library.py`
   - é—®é¢˜ï¼š`update_library_with_files()` æ–¹æ³•é•¿è¾¾ 790 è¡Œ
   - å»ºè®®ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªå°æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•ä¸è¶…è¿‡ 100 è¡Œ

2. **æ”¹è¿›æ—¥å¿—ç®¡ç†**
   - é—®é¢˜ï¼šæ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸ä¸€è‡´ï¼Œç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—
   - å»ºè®®ï¼šç»Ÿä¸€æ—¥å¿—è§„èŒƒï¼Œæ·»åŠ æ—¥å¿—è„±æ•åŠŸèƒ½

### ä¸­ä¼˜å…ˆçº§
3. **æ¸…ç†æœªä½¿ç”¨æ–‡ä»¶**
   - æ–‡ä»¶ï¼š`src/bash_logger_wrapper.py`, `src/robust_logger_wrapper.py`
   - å»ºè®®ï¼šåˆ é™¤æˆ–ç¡®è®¤æ˜¯å¦éœ€è¦

4. **æ·»åŠ ç±»å‹æ³¨è§£**
   - é—®é¢˜ï¼šå¤§éƒ¨åˆ†å‡½æ•°ç¼ºå°‘ç±»å‹æ³¨è§£
   - å»ºè®®ï¼šä½¿ç”¨ mypy è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œæ·»åŠ ç±»å‹æ³¨è§£

5. **æ·»åŠ æµ‹è¯•**
   - é—®é¢˜ï¼šç¼ºå°‘å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
   - å»ºè®®ï¼šæ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œç›®æ ‡è¦†ç›–ç‡ > 80%

### ä½ä¼˜å…ˆçº§
6. **æ”¹è¿›æ–‡æ¡£**
   - é—®é¢˜ï¼šç¼ºå°‘ API æ–‡æ¡£
   - å»ºè®®ï¼šä½¿ç”¨ Sphinx ç”Ÿæˆ API æ–‡æ¡£

7. **ç§»é™¤ç¡¬ç¼–ç **
   - é—®é¢˜ï¼šéƒ¨åˆ†è·¯å¾„å’Œé…ç½®ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
   - å»ºè®®ï¼šç§»åˆ°é…ç½®æ–‡ä»¶ä¸­

---

## ğŸš€ ä½¿ç”¨æ–°åŠŸèƒ½

### ä½¿ç”¨ EnvironmentDetector

```python
from src.utils.environment import env_detector, is_docker, is_test_env

# æ£€æŸ¥ç¯å¢ƒ
if env_detector.is_docker():
    print("åœ¨ Docker ç¯å¢ƒä¸­è¿è¡Œ")

# ä½¿ç”¨ä¾¿æ·å‡½æ•°
if is_docker():
    print("åœ¨ Docker ç¯å¢ƒä¸­è¿è¡Œ")

# è·å–å®Œæ•´ç¯å¢ƒä¿¡æ¯
info = env_detector.get_environment_info()
print(info)
```

### ä½¿ç”¨é”™è¯¯å¤„ç†

```python
from src.utils.error_handler import (
    PlexAutoScanError,
    ConfigurationError,
    handle_errors,
    safe_execute
)

# ä½¿ç”¨è£…é¥°å™¨
@handle_errors(default_return=None, reraise=False)
def my_function():
    # å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
    pass

# ä½¿ç”¨å®‰å…¨æ‰§è¡Œ
result = safe_execute(
    my_function,
    default_return=None,
    reraise=False
)

# æŠ›å‡ºç‰¹å®šå¼‚å¸¸
if not config:
    raise ConfigurationError("é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°")
```

### ä½¿ç”¨è¶…æ—¶é…ç½®

```python
from src.utils.timeout_decorator import timeout_config, run_with_timeout

# è·å–è¶…æ—¶æ—¶é—´
timeout = timeout_config.get_timeout(category='medium')

# ä½¿ç”¨è¶…æ—¶é…ç½®æ‰§è¡Œå‡½æ•°
result = run_with_timeout(
    my_function,
    timeout_seconds=timeout,
    default=None
)
```

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**ï¼šæ‰€æœ‰ä¼˜åŒ–éƒ½ä¿æŒäº†å‘åå…¼å®¹æ€§ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ
2. **æ€§èƒ½å½±å“**ï¼šæ–°å¢çš„ç¼“å­˜æœºåˆ¶å®é™…ä¸Šæé«˜äº†æ€§èƒ½
3. **æµ‹è¯•å»ºè®®**ï¼šå»ºè®®åœ¨éƒ¨ç½²å‰è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯é…ç½®è§£æå’Œç¯å¢ƒæ£€æµ‹éƒ¨åˆ†

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š
- âœ… æ¶ˆé™¤äº†ä»£ç é‡å¤
- âœ… ä¿®å¤äº†å®‰å…¨éšæ‚£
- âœ… ç»Ÿä¸€äº†é”™è¯¯å¤„ç†ç­–ç•¥
- âœ… æ”¹è¿›äº†é…ç½®ç®¡ç†
- âœ… ç»Ÿä¸€äº†è¶…æ—¶å¤„ç†
- âœ… æ›´æ–°äº†ä¾èµ–ç®¡ç†

ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§å¾—åˆ°äº†æ˜¾è‘—æå‡ï¼Œä¸ºåç»­çš„åŠŸèƒ½å¼€å‘å’Œç»´æŠ¤æ‰“ä¸‹äº†è‰¯å¥½çš„åŸºç¡€ã€‚
